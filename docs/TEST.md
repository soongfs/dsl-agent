# 测试报告

本文档描述本项目的测试设计与执行，覆盖解析器、解释器、意图服务以及示例脚本的端到端验证。测试全部基于 Python/pytest，默认离线（不依赖真实 LLM）。

## 1. 测试驱动设计说明

- **目标**：验证 DSL 语法/语义校验、解释器状态机逻辑、意图识别抽象，以及示例脚本行为的稳定性。
- **方法**：使用 pytest 作为驱动框架；单元测试覆盖解析错误分支与正常分支；集成测试基于“黄金转录”对话序列逐步断言回复、状态和结束标记。
- **输入/输出**：输入为 DSL 脚本、桩意图映射和用户话术序列；输出为解释器回复、状态迁移和结束标志，测试通过断言与黄金数据比对。
- **可重复性**：所有测试使用确定性桩或假客户端，避免外部依赖，确保在 CI/本地一致。

## 2. 测试桩设计说明

- **StubIntentService（dsl_agent.intent_service）**：按 `mapping: state -> {trigger -> intent}` 的确定性映射返回意图，可选 `default_intent` 兜底；用于解释器与黄金对话测试。
- **LLMIntentService 假客户端**：`tests/test_intent_service.py` 中注入 `_DummyClient`，固定返回模型回复字符串，用于验证 LLM 结果归一化逻辑（截断/小写/tokenize），不做真实网络调用。
- **目的**：隔离网络与真实模型的不确定性，使逻辑测试只关注解析/状态机/格式。

## 3. 自动测试脚本设计说明

- **解析器单测**（`tests/test_parser.py`）：构造合法/非法脚本，覆盖缺省初始状态、重复 default、未定义 goto、大小写违规、缺分号、重复状态名等路径，期望抛 `ParseError` 或返回合法 `Scenario`。
- **解释器单测**（`tests/test_interpreter.py`）：使用桩意图验证正常流、default 兜底、自循环、`end` 终止、`reset` 行为，以及结束后继续调用的异常。
- **意图服务归一化单测**（`tests/test_intent_service.py`）：用假客户端返回不同字符串，断言归一化为允许意图或 `None`。
- **黄金用例集成**（`tests/test_golden.py` + `tests/data/golden_*.json`）：针对 `travel/refund/support/faq/appointment` 脚本，驱动固定用户输入与桩意图序列，逐步断言回复包含关键片段、当前状态、结束标记。
- **运行方式**：在项目根目录执行 `python -m pytest`；无需环境变量或真实 API。

## 4. 测试过程

1. 准备环境：安装依赖（`uv sync --extra dev` 或等效 `pip install -e .[dev]`），确保无真实 API key 也可运行。
2. 执行 `python -m pytest`；默认全部使用桩/假客户端，无网络请求。
3. 如需单独运行某类测试，可使用 `-k parser`、`-k golden` 等筛选。
4. 若后续需要真实 LLM 冒烟，可额外设置环境变量并单独编写/运行，不纳入常规回归。

## 5. 测试结果

- （占位）本节待执行实际测试后补充，可包含：
  - 用例通过/失败统计（总数/通过数/失败数）。
  - 失败用例及原因摘要（如解析错误、预期回复不符等）。
  - 环境信息（Python 版本、依赖版本、运行命令）。
  - 若有截图/日志摘录可在此引用路径。***
